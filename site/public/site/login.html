<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Login e Cadastro</title>
    <link rel="stylesheet" href="../css/stylehome2.css">
    

      
</head>

<body>


      <div class="CaixaLoginCadastro">

          
          <div class="TextoTitulo">
             <div class="dattebayo">
                 DATTEBAYO
             </div>
          </div>

         <div class="EspaçoLoginCadastro">

            <div class="SlideCima">
               <input type="radio" name="slide" id="login" checked>
               <input type="radio" name="slide" id="cadastro">
               <label for="login" class="slide login">Login</label>
               <label for="cadastro" class="slide cadastro">Cadastro</label>
               <div class="slider-tab"></div>
            </div>

            <div class="SlideBaixo">
               <form action="#" class="login">   <!-- Ver o que faz -->

                  <div class="inputDados">
                     <input type="text" placeholder="Seu E-mail ninja" required 
                     id="email_input_login">
                  </div>

                  <div class="inputDados">
                     <input type="password" placeholder="Aquela Palavrinha Secreta" required
                     id="senha_input_login">
                  </div>
                  
                  <div class="inputDados btn">
                     <div class="divBotao"></div>
                     <input type="submit" value="Login" onclick="entrar()">
                  </div>

                  <div class="LinkCadastro">
                     Não é um ninja? <a href="">Cadastre-se agora pô</a>
                  </div>

               </form>



               <form action="#" class="cadastro">

                  <div class="inputDados">
                     <input type="text" placeholder="Nome completo" required id="nome_input_cadastro">
                  </div>

                  <div class="inputDados">
                     <input type="text" placeholder="Seu E-mail ninja" required id="email_input_cadastro">
                  </div>

                  <div class="inputDados">
                     <input type="password" placeholder="Senha" required id="senha_input_cadastro">
                  </div>

                  <div class="inputDados">
                     <input type="password" placeholder="Confirme sua Senha" required
                     id="senha_confirmacao_cadastro">
                  </div>

                  <div class="inputDados btn">
                     <div class="divBotao"></div>
                     <input type="submit" value="Realizar Cadastro" onclick="cadastrar()">
                  </div>

               </form>


            </div>

            
         </div>
      </div>
      <script>

         const textoLogin = document.querySelector("login")
         const parteDeBaixo = document.querySelector("form.login")
         const botaoLogin = document.querySelector("label.login")
         const botaoCadastro = document.querySelector("label.cadastro")
         const linkCadastro = document.querySelector("form .LinkCadastro a")

         botaoCadastro.onclick = (()=>{
           parteDeBaixo.style.marginLeft = "-50%"
           textoLogin.style.marginLeft = "-50%"
         })
         botaoLogin.onclick = (()=>{
           parteDeBaixo.style.marginLeft = "0%"
           textoLogin.style.marginLeft = "0%"
         })
         linkCadastro.onclick = (()=>{
           botaoCadastro.click()
           return false
         })


         function entrar() {
      //  aguardar();

      var emailVar = email_input_login.value;
      var senhaVar = senha_input_login.value;


      if (emailVar == "" || senhaVar == "") {
        cardAcertoLogin.style.display = "block"
        mensagem_acertoLogin.innerHTML = "Mensagem de erro para todos os campos em branco";
        // finalizarAguardar();
        return false;
      }
      else {
        setInterval(sumirMensagem, 5000)
      }

      console.log("FORM LOGIN: ", emailVar);
      console.log("FORM SENHA: ", senhaVar);

      fetch("/usuarios/autenticar", {
        method: "POST",
        headers: {
          "Content-Type": "application/json"
        },
        body: JSON.stringify({
          emailServer: emailVar,
          senhaServer: senhaVar
        })
      }).then(function (resposta) {
        console.log("ESTOU NO THEN DO entrar()!")

        if (resposta.ok) {
          console.log(resposta);

          resposta.json().then(json => {
            console.log(json);
            console.log(JSON.stringify(json));
            sessionStorage.EMAIL_USUARIO = json.email;
            sessionStorage.NOME_USUARIO = json.nome;

            setTimeout(function () {
              window.location = "../site/index.html";
            }, 1000);

          });

        } else {

          console.log("Houve um erro ao tentar realizar o login!");

          resposta.text().then(texto => {
            console.error(texto);
            finalizarAguardar(texto);
          });
        }

      }).catch(function (erro) {
        console.log(erro);
      })

      return false;
    }


    function sumirMensagem() {
      cardAcertostyle.display = "none"
    }

    // Realizar Cadastro
    // Array para armazenar empresas cadastradas para validação de código de ativação 
    let listaEmpresasCadastradas = [];

    function cadastrar() {
      // aguardar();

      //Recupere o valor da nova input pelo nome do id
      // Agora vá para o método fetch logo abaixo
      var nomeVar = nome_input_cadastro.value;
      var emailVar = email_input_cadastro.value;
      var senhaVar = senha_input_cadastro.value;
      var confirmacaoSenhaVar = senha_confirmacao_cadastro.value;

      // Verificando se há algum campo em branco
      if (
        nomeVar == "" ||
        emailVar == "" ||
        senhaVar == "" ||
        confirmacaoSenhaVar == ""
      ) {
        cardErro.style.display = "block";
        mensagem_erro.innerHTML =
          "Preencha todas as informações para cadastrar";
        
          setTimeout(() => {
            cardErro.style.display = "none";
          },3000);

        finalizarAguardar();
        return false;
      } else {
        setInterval(sumirMensagem, 5000);
      }


      // Enviando o valor da nova input
      fetch("/usuarios/cadastrar", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
        },
        body: JSON.stringify({
          // crie um atributo que recebe o valor recuperado aqui
          // Agora vá para o arquivo routes/usuario.js

          nomeServer: nomeVar,
          emailServer: emailVar,
          senhaServer: senhaVar

        }),
      })
        .then(function (resposta) {
          console.log("resposta: ", resposta);

          if (resposta.ok) {
            cardAcerto.style.display = "block";

            mensagem_acerto.innerHTML =
              "Cadastro realizado com sucesso!";

              setTimeout(() => {
            cardAcerto.style.display = "none";
          },3000);

            limparFormulario();
            finalizarAguardar();
          } else {
            throw "Houve um erro ao tentar realizar o cadastro!";
          }
        })
        .catch(function (resposta) {
          console.log(`#ERRO: ${resposta}`);
          finalizarAguardar();
        });

      return false;
    }

    // Listando empresas cadastradas 
    function listar() {
      fetch("/empresas/listar", {
        method: "GET",
      })
        .then(function (resposta) {
          resposta.json().then((empresas) => {
            empresas.forEach((empresa) => {
              listaEmpresasCadastradas.push(empresa);

              console.log("listaEmpresasCadastradas")
              console.log(listaEmpresasCadastradas[0].codigo_ativacao)
            });
          });
        })
        .catch(function (resposta) {
          console.log(`#ERRO: ${resposta}`);
        });
    }

    function sumirMensagem() {
      cardErro.style.display = "none";
    }
      </script>
   </body>
</html>